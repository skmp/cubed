<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CUBED Documentation</title>

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:title" content="CUBED - GA144 Emulator & CUBE 3D Language">
<meta property="og:description" content="Open-source emulator for the GreenArrays GA144 144-core chip, with an experimental 3D visual logic programming language. Write, visualize, and step through massively parallel Forth programs in your browser.">
<meta property="og:url" content="https://github.com/skmp/cubed">
<meta property="og:image" content="social.png">

<!-- Twitter / X -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="CUBED - GA144 Emulator & CUBE 3D Language">
<meta name="twitter:description" content="Open-source emulator for the GreenArrays GA144 144-core chip, with an experimental 3D visual logic programming language.">
<meta name="twitter:image" content="social.png">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='15' y='25' width='50' height='50' rx='4' fill='none' stroke='%2358a6ff' stroke-width='5' transform='skewX(-10) skewY(5)'/><rect x='30' y='15' width='50' height='50' rx='4' fill='none' stroke='%23bc8cff' stroke-width='5' transform='skewX(-10) skewY(5)'/></svg>">
<style>
  :root {
    --bg: #0e1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent-hover: #79c0ff;
    --green: #3fb950;
    --purple: #bc8cff;
    --orange: #d29922;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }
  header {
    border-bottom: 1px solid var(--border);
    padding: 2rem 0;
    text-align: center;
  }
  header h1 {
    font-size: 2rem;
    font-weight: 600;
    letter-spacing: -0.02em;
  }
  header h1 span { color: var(--accent); }
  header p {
    color: var(--text-muted);
    margin-top: 0.5rem;
    font-size: 0.95rem;
  }
  main {
    max-width: 64rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }
  .section-title {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    padding-left: 0.25rem;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2.5rem;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.15s, transform 0.15s;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }
  .card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
  }
  .card h3 {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .card p {
    color: var(--text-muted);
    font-size: 0.85rem;
    flex: 1;
  }
  .tag {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.15em 0.5em;
    border-radius: 10px;
    border: 1px solid;
  }
  .tag-hw    { color: var(--green);  border-color: var(--green); }
  .tag-lang  { color: var(--purple); border-color: var(--purple); }
  .tag-prog  { color: var(--orange); border-color: var(--orange); }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }
  .dot-hw   { background: var(--green); }
  .dot-lang { background: var(--purple); }
  .dot-prog { background: var(--orange); }
  footer {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
    font-size: 0.8rem;
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--accent); text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  .about {
    max-width: 64rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 0;
  }
  .about-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem 2rem;
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  }
  .about-text { flex: 1; }
  .about-text p { color: var(--text-muted); font-size: 0.9rem; margin: 0.5rem 0; }
  .about-text p:first-child { color: var(--text); font-size: 0.95rem; }
  .about-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  .about-links a {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9rem;
    padding: 0.4rem 0.9rem;
    border: 1px solid var(--accent);
    border-radius: 6px;
    transition: background 0.15s;
  }
  .about-links a:hover {
    background: rgba(88,166,255,0.1);
  }
  @media (max-width: 600px) {
    .about-inner { flex-direction: column; gap: 1rem; }
  }

  #viewer {
    display: none;
    max-width: 52rem;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }
  #viewer.active { display: block; }
  #index.hidden  { display: none; }

  #back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    cursor: pointer;
    background: none;
    border: none;
    font-family: inherit;
  }
  #back-btn:hover { color: var(--accent-hover); }

  /* Rendered markdown styles */
  .md-content h1 { font-size: 1.75rem; margin: 0 0 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  .md-content h2 { font-size: 1.35rem; margin: 2rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.3rem; }
  .md-content h3 { font-size: 1.1rem; margin: 1.5rem 0 0.5rem; }
  .md-content h4 { font-size: 1rem; margin: 1.25rem 0 0.5rem; }
  .md-content p  { margin: 0.75rem 0; }
  .md-content ul, .md-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
  .md-content li { margin: 0.25rem 0; }
  .md-content code {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    background: rgba(110,118,129,0.15);
    padding: 0.15em 0.35em;
    border-radius: 4px;
    font-size: 0.88em;
  }
  .md-content pre {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
  }
  .md-content pre code {
    background: none;
    padding: 0;
    font-size: 0.85rem;
    line-height: 1.5;
  }
  .md-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
    font-size: 0.9rem;
  }
  .md-content th, .md-content td {
    border: 1px solid var(--border);
    padding: 0.5rem 0.75rem;
    text-align: left;
  }
  .md-content th { background: var(--surface); font-weight: 600; }
  .md-content blockquote {
    border-left: 3px solid var(--border);
    color: var(--text-muted);
    padding: 0.25rem 1rem;
    margin: 1rem 0;
  }
  .md-content strong { color: #e6edf3; }
  .md-content a { color: var(--accent); text-decoration: none; }
  .md-content a:hover { text-decoration: underline; }
  .md-content hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }

  /* Derived-from source banner */
  .derived-from {
    background: rgba(88,166,255,0.08);
    border: 1px solid rgba(88,166,255,0.2);
    border-radius: 6px;
    padding: 0.5rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }
  .derived-from a { color: var(--accent); text-decoration: none; }
  .derived-from a:hover { text-decoration: underline; }

  /* Plain text viewer */
  .txt-content {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.85rem;
    line-height: 1.6;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1.5rem;
    overflow-x: auto;
  }

  /* Reference document list */
  .ref-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 0.5rem;
    margin-bottom: 2.5rem;
  }
  .ref-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    text-decoration: none;
    color: var(--text);
    font-size: 0.85rem;
    transition: border-color 0.15s;
  }
  .ref-item:hover { border-color: var(--accent); }
  .ref-item .ref-id { color: var(--accent); font-weight: 600; min-width: 3.5rem; }
  .ref-item .ref-title { color: var(--text-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .ref-item .ref-links { display: flex; gap: 0.4rem; flex-shrink: 0; }
  .ref-item .ref-links a {
    color: var(--text-muted);
    font-size: 0.75rem;
    padding: 0.1rem 0.4rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    text-decoration: none;
  }
  .ref-item .ref-links a:hover { color: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>

<header>
  <h1><span>CUBED</span> Documentation</h1>
  <p>GA144 / EVB002 Emulator &amp; CUBE Language Reference</p>
</header>

<section class="about">
  <div class="about-inner">
    <div class="about-text">
      <p>CUBED is an open-source emulator for the GreenArrays GA144 multi-computer chip and EVB002 evaluation board, paired with an experimental implementation of the CUBE 3D visual logic programming language.</p>
      <p>The GA144 packs 144 tiny 18-bit Forth processors into a single chip, communicating through a mesh of blocking ports. CUBED lets you write, visualize, and step through programs for this unusual architecture right in your browser.</p>
      <p>This is an early-stage research project. Contributions are very welcome &mdash; whether that's improving emulation accuracy, extending the CUBE compiler, building new samples, writing docs, or just filing bugs. If massively parallel stack machines or 3D visual languages sound interesting to you, come help out!</p>
    </div>
    <div class="about-links">
      <a href="https://github.com/skmp/cubed" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        GitHub
      </a>
      <a href="https://github.com/skmp/cubed/issues" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 9.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM8 0a8 8 0 100 16A8 8 0 008 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"/></svg>
        Report Issues
      </a>
      <a href="https://x.com/poiitidis" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Twitter / X
      </a>
      <a href="https://discord.gg/emudev" target="_blank" rel="noopener">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.095 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.095 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
        Discord
      </a>
    </div>
  </div>
</section>

<main id="index">
  <div class="section-title">Application</div>
  <div class="grid">
    <a class="card" href="dist/" style="border-color: var(--accent);">
      <h3><span class="dot" style="background: var(--accent);"></span>CUBED Emulator</h3>
      <p>GA144/EVB002 emulator with CUBE 3D visualization, arrayForth assembler, and node inspector.</p>
      <span class="tag" style="color: var(--accent); border-color: var(--accent);">app</span>
    </a>
  </div>

  <div class="section-title">CUBE Language</div>
  <div class="grid">
    <a class="card" href="#cube-language.md" data-file="cube-language.md">
      <h3><span class="dot dot-lang"></span>CUBE Language Spec</h3>
      <p>3D visual logic programming language &mdash; syntax, semantics, type system, and visual encoding.</p>
      <span class="tag tag-lang">language</span>
    </a>
  </div>

  <div class="section-title">F18A Processor</div>
  <div class="grid">
    <a class="card" href="#f18a-architecture.md" data-file="f18a-architecture.md">
      <h3><span class="dot dot-hw"></span>F18A Architecture</h3>
      <p>18-bit stack-based core: registers, memory map, stacks, and extended arithmetic mode.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
    <a class="card" href="#f18a-instruction-set.md" data-file="f18a-instruction-set.md">
      <h3><span class="dot dot-hw"></span>F18A Instruction Set</h3>
      <p>Complete opcode reference with slot encoding, instruction packing, and execution details.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
  </div>

  <div class="section-title">GA144 Chip</div>
  <div class="grid">
    <a class="card" href="#ga144-node-map.md" data-file="ga144-node-map.md">
      <h3><span class="dot dot-hw"></span>Node Map</h3>
      <p>8&times;18 mesh topology, node numbering, and inter-node communication ports.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
    <a class="card" href="#ga144-io.md" data-file="ga144-io.md">
      <h3><span class="dot dot-hw"></span>I/O System</h3>
      <p>Port addresses, GPIO pins, analog I/O, and the I/O register map.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
    <a class="card" href="#ga144-boot.md" data-file="ga144-boot.md">
      <h3><span class="dot dot-hw"></span>Boot Process</h3>
      <p>Boot sequences, wire protocol, async boot streams, and multi-node loading.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
    <a class="card" href="#ga144-application-notes.md" data-file="ga144-application-notes.md">
      <h3><span class="dot dot-hw"></span>Application Notes</h3>
      <p>AN001&ndash;AN012: partner nodes, wire protocol, SPI flash, I2C, and more.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
  </div>

  <div class="section-title">Programming</div>
  <div class="grid">
    <a class="card" href="#arrayforth-compiler.md" data-file="arrayforth-compiler.md">
      <h3><span class="dot dot-prog"></span>arrayForth Compiler</h3>
      <p>Compiler internals: tokenization, instruction packing, labels, directives, and ROM layout.</p>
      <span class="tag tag-prog">tooling</span>
    </a>
    <a class="card" href="#programming-patterns.md" data-file="programming-patterns.md">
      <h3><span class="dot dot-prog"></span>Programming Patterns</h3>
      <p>Idiomatic F18A patterns: loops, conditionals, inter-node messaging, and stack techniques.</p>
      <span class="tag tag-prog">patterns</span>
    </a>
    <a class="card" href="#cubec.md" data-file="cubec.md">
      <h3><span class="dot dot-prog"></span>cubec CLI</h3>
      <p>Command-line compiler for CUBE programs: options, JSON output, and disassembly.</p>
      <span class="tag tag-prog">tooling</span>
    </a>
    <a class="card" href="#samples.md" data-file="samples.md">
      <h3><span class="dot dot-prog"></span>Sample Programs</h3>
      <p>Catalog of CUBE and arrayForth samples with difficulty and behavior notes.</p>
      <span class="tag tag-prog">samples</span>
    </a>
  </div>

  <div class="section-title">Architecture</div>
  <div class="grid">
    <a class="card" href="#architecture.md" data-file="architecture.md">
      <h3><span class="dot dot-prog"></span>System Overview</h3>
      <p>High-level architecture and data flow for the emulator and UI.</p>
      <span class="tag tag-prog">architecture</span>
    </a>
  </div>

  <div class="section-title">Performance</div>
  <div class="grid">
    <a class="card" href="#vga-profiling.md" data-file="vga-profiling.md">
      <h3><span class="dot dot-prog"></span>VGA Profiling</h3>
      <p>Performance capture checklist for VGA rendering and memory usage.</p>
      <span class="tag tag-prog">performance</span>
    </a>
  </div>

  <div class="section-title">ROM Disassembly</div>
  <div class="grid">
    <a class="card" href="#rom/README.md" data-file="rom/README.md">
      <h3><span class="dot dot-hw"></span>ROM Disassembly Index</h3>
      <p>Disassembled ROM contents for all GA144 node types: boot, analog, basic, and serial.</p>
      <span class="tag tag-hw">hardware</span>
    </a>
  </div>

  <div class="section-title">GreenArrays Reference Documents</div>
  <div id="ref-docs" class="ref-list"></div>

  <div class="section-title">CUBE Language Papers</div>
  <div class="ref-list">
    <div class="ref-item">
      <span class="ref-id">VL91</span>
      <span class="ref-title">Visual Programming in 3-D (Najork & Kaplan, 1991)</span>
      <span class="ref-links">
        <a href="#txt/vl1991.txt" onclick="event.preventDefault();history.pushState(null,'','#txt/vl1991.txt');showDoc('txt/vl1991.txt')">TXT</a>
        <a href="pdf/cube/vl1991.pdf" target="_blank">PDF</a>
      </span>
    </div>
    <div class="ref-item">
      <span class="ref-id">VL92</span>
      <span class="ref-title">Computing with 3-D Type Visualizations (Najork & Kaplan, 1992)</span>
      <span class="ref-links">
        <a href="#txt/vl1992.txt" onclick="event.preventDefault();history.pushState(null,'','#txt/vl1992.txt');showDoc('txt/vl1992.txt')">TXT</a>
        <a href="pdf/cube/vl1992.pdf" target="_blank">PDF</a>
      </span>
    </div>
    <div class="ref-item">
      <span class="ref-id">JVLC96</span>
      <span class="ref-title">Programming in Three Dimensions (Najork, 1996)</span>
      <span class="ref-links">
        <a href="#txt/jvlc1996.txt" onclick="event.preventDefault();history.pushState(null,'','#txt/jvlc1996.txt');showDoc('txt/jvlc1996.txt')">TXT</a>
        <a href="pdf/cube/jvlc1996.pdf" target="_blank">PDF</a>
      </span>
    </div>
  </div>
</main>

<div id="viewer">
  <button id="back-btn">&larr; Back to index</button>
  <div id="md-content" class="md-content"></div>
</div>

<footer>
  <a href="dist/">Launch Emulator App</a> &middot;
  <a href="https://github.com/skmp/cubed" target="_blank" rel="noopener">GitHub</a> &middot;
  <a href="https://x.com/poiitidis" target="_blank" rel="noopener">Twitter / X</a> &middot;
  <a href="https://discord.gg/emudev" target="_blank" rel="noopener">Discord</a>
</footer>

<script>
// ---- Path mapping for deployed site ----
// txt [Derived from:] headers contain repo-relative paths like ../../reference/greenarrays/BASENAME.compact.html
// On the deployed site, PDFs live at pdf/greenarrays/BASENAME.pdf and pdf/cube/BASENAME.pdf
function derivedPathToUrl(path) {
  // ../../reference/greenarrays/BASENAME.compact.html -> pdf/greenarrays/BASENAME.pdf
  let m = path.match(/\.\.\/\.\.\/reference\/greenarrays\/([^/]+)\.compact\.html$/);
  if (m) return { url: 'pdf/greenarrays/' + m[1] + '.pdf', label: m[1], kind: 'pdf' };
  // ../../reference/cube/BASENAME.compact.html -> pdf/cube/BASENAME.pdf
  m = path.match(/\.\.\/\.\.\/reference\/cube\/([^/]+)\.compact\.html$/);
  if (m) return { url: 'pdf/cube/' + m[1] + '.pdf', label: m[1], kind: 'pdf' };
  // ../../reference/cube/pdf/BASENAME.pdf -> pdf/cube/BASENAME.pdf
  m = path.match(/\.\.\/\.\.\/reference\/cube\/pdf\/([^/]+\.pdf)$/);
  if (m) return { url: 'pdf/cube/' + m[1], label: m[1].replace('.pdf',''), kind: 'pdf' };
  return { url: path, label: path.split('/').pop(), kind: 'unknown' };
}

// ---- Resolve relative paths against a base directory ----
function resolveHref(href, basePath) {
  if (href.startsWith('http') || href.startsWith('#') || href.startsWith('/')) return href;
  if (!basePath) return href;
  // ../txt/X.txt from rom/ -> txt/X.txt
  const parts = (basePath + '/' + href).split('/');
  const resolved = [];
  for (const p of parts) {
    if (p === '..') resolved.pop();
    else if (p !== '.') resolved.push(p);
  }
  return resolved.join('/');
}

// Current base path for resolving relative links in md files
let currentBasePath = '';

// ---- Minimal markdown-to-HTML renderer (no dependencies) ----
function md(src) {
  src = src.replace(/\r\n/g, '\n');

  // Extract and remove "> Sources:" blockquote header
  let derivedFrom = '';
  function makeDerivedLink(text, href) {
    const resolved = resolveHref(href, currentBasePath);
    if (resolved.endsWith('.txt') && !resolved.startsWith('http')) {
      const name = resolved.replace(/^txt\//, '').replace('.txt', '');
      return `<a href="#${resolved}" onclick="event.preventDefault();history.pushState(null,'','#${resolved}');showDoc('${resolved}')">${name}</a> (<a href="pdf/greenarrays/${name}.pdf" target="_blank">PDF</a>)`;
    }
    if (resolved.endsWith('.md') && !resolved.startsWith('http')) {
      return `<a href="#${resolved}" onclick="event.preventDefault();history.pushState(null,'','#${resolved}');showDoc('${resolved}')">${text}</a>`;
    }
    return `<a href="${resolved}" target="_blank">${text}</a>`;
  }
  // Multi-line: > Sources:\n> - [link](path)\n> - [link](path)
  src = src.replace(/^> Sources:[ \t]*\n((?:> - .+\n)+)\n?/, (_, items) => {
    const links = [];
    items.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (__, text, href) => { links.push(makeDerivedLink(text, href)); });
    derivedFrom = `<div class="derived-from">Sources: ${links.join(', ')}</div>`;
    return '';
  });
  // Single-line: > Sources: [link](path), [link](path)
  if (!derivedFrom) {
    src = src.replace(/^> Sources:\s+(.+)\n\n?/, (_, rest) => {
      const links = [];
      rest.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (__, text, href) => { links.push(makeDerivedLink(text, href)); });
      derivedFrom = `<div class="derived-from">Sources: ${links.join(', ')}</div>`;
      return '';
    });
  }

  // Fenced code blocks
  src = src.replace(/^```(\w*)\n([\s\S]*?)^```/gm, (_, lang, code) =>
    `<pre><code class="lang-${lang || 'text'}">${esc(code.trimEnd())}</code></pre>`
  );

  // Tables
  src = src.replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)*)/gm, (_, hdr, _sep, body) => {
    const th = hdr.split('|').slice(1, -1).map(c => `<th>${inline(c.trim())}</th>`).join('');
    const rows = body.trim().split('\n').map(r => {
      const cells = r.split('|').slice(1, -1).map(c => `<td>${inline(c.trim())}</td>`).join('');
      return `<tr>${cells}</tr>`;
    }).join('\n');
    return `<table><thead><tr>${th}</tr></thead><tbody>${rows}</tbody></table>`;
  });

  // Block-level
  const lines = src.split('\n');
  let html = '';
  let inList = false;
  let listType = '';
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (line.startsWith('<pre>') || line.startsWith('<table>')) {
      let block = line;
      const closeTag = line.startsWith('<pre>') ? '</pre>' : '</table>';
      while (!block.includes(closeTag) && i + 1 < lines.length) {
        i++;
        block += '\n' + lines[i];
      }
      if (inList) { html += `</${listType}>`; inList = false; }
      html += block + '\n';
      continue;
    }

    const hm = line.match(/^(#{1,6})\s+(.+)/);
    if (hm) {
      if (inList) { html += `</${listType}>`; inList = false; }
      const lvl = hm[1].length;
      html += `<h${lvl}>${inline(hm[2])}</h${lvl}>\n`;
      continue;
    }

    if (/^[-*_]{3,}\s*$/.test(line)) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += '<hr>\n';
      continue;
    }

    if (line.startsWith('> ')) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += `<blockquote><p>${inline(line.slice(2))}</p></blockquote>\n`;
      continue;
    }

    const ulm = line.match(/^(\s*)[-*+]\s+(.*)/);
    if (ulm) {
      if (!inList || listType !== 'ul') {
        if (inList) html += `</${listType}>`;
        html += '<ul>'; inList = true; listType = 'ul';
      }
      html += `<li>${inline(ulm[2])}</li>\n`;
      continue;
    }

    const olm = line.match(/^(\s*)\d+[.)]\s+(.*)/);
    if (olm) {
      if (!inList || listType !== 'ol') {
        if (inList) html += `</${listType}>`;
        html += '<ol>'; inList = true; listType = 'ol';
      }
      html += `<li>${inline(olm[2])}</li>\n`;
      continue;
    }

    if (inList && line.trim() === '') {
      html += `</${listType}>\n`; inList = false;
      continue;
    }

    if (line.trim()) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += `<p>${inline(line)}</p>\n`;
    }
  }
  if (inList) html += `</${listType}>`;
  return derivedFrom + html;
}

function esc(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function inline(s) {
  s = s.replace(/`([^`]+)`/g, (_, c) => `<code>${esc(c)}</code>`);
  s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Links: resolve relative paths, make txt/md links open in viewer
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, text, href) => {
    const resolved = resolveHref(href, currentBasePath);
    if (resolved.endsWith('.txt') && !resolved.startsWith('http')) {
      const name = resolved.replace(/^txt\//, '').replace('.txt', '');
      return `<a href="#${resolved}" onclick="event.preventDefault();history.pushState(null,'','#${resolved}');showDoc('${resolved}')">${text}</a> (<a href="pdf/greenarrays/${name}.pdf" target="_blank" title="Original PDF">PDF</a>)`;
    }
    if (resolved.endsWith('.md') && !resolved.startsWith('http')) {
      return `<a href="#${resolved}" onclick="event.preventDefault();history.pushState(null,'','#${resolved}');showDoc('${resolved}')">${text}</a>`;
    }
    return `<a href="${resolved}" target="_blank" rel="noopener">${text}</a>`;
  });
  s = s.replace(/&mdash;/g, '\u2014');
  s = s.replace(/&ndash;/g, '\u2013');
  s = s.replace(/&times;/g, '\u00D7');
  return s;
}

// ---- Render plain text file ----
function renderTxt(src) {
  // Extract [Derived from: ...] header
  let banner = '';
  src = src.replace(/^\[Derived from:\s*(.+?)\]\s*\n?/, (_, ref) => {
    const info = derivedPathToUrl(ref.trim());
    banner = `<div class="derived-from">Source: <a href="${info.url}" target="_blank">${info.label} (${info.kind.toUpperCase()})</a></div>`;
    return '';
  });
  return banner + '<div class="txt-content">' + esc(src) + '</div>';
}

// ---- Navigation ----
const indexEl = document.getElementById('index');
const viewer = document.getElementById('viewer');
const content = document.getElementById('md-content');
const backBtn = document.getElementById('back-btn');

function showIndex() {
  viewer.classList.remove('active');
  indexEl.classList.remove('hidden');
  history.pushState(null, '', window.location.pathname);
}

async function showDoc(file) {
  try {
    const resp = await fetch(file);
    if (!resp.ok) throw new Error(`${resp.status}`);
    const text = await resp.text();
    // Set base path for resolving relative links (e.g. 'rom' for 'rom/README.md')
    const lastSlash = file.lastIndexOf('/');
    currentBasePath = lastSlash > 0 ? file.substring(0, lastSlash) : '';
    if (file.endsWith('.txt')) {
      content.innerHTML = renderTxt(text);
    } else {
      content.innerHTML = md(text);
    }
    indexEl.classList.add('hidden');
    viewer.classList.add('active');
    window.scrollTo(0, 0);
  } catch (e) {
    content.innerHTML = `<p>Failed to load <code>${esc(file)}</code>: ${esc(e.message)}</p>`;
    indexEl.classList.add('hidden');
    viewer.classList.add('active');
  }
}

// Card click handlers
document.querySelectorAll('.card[data-file]').forEach(card => {
  card.addEventListener('click', e => {
    e.preventDefault();
    const file = card.dataset.file;
    history.pushState(null, '', '#' + file);
    showDoc(file);
  });
});

backBtn.addEventListener('click', showIndex);

// Handle back/forward and direct hash links
window.addEventListener('hashchange', () => {
  const h = location.hash.slice(1);
  if (h && (h.endsWith('.md') || h.endsWith('.txt'))) showDoc(h);
  else showIndex();
});

// Initial load
(function() {
  const h = location.hash ? location.hash.slice(1) : '';
  if (h && (h.endsWith('.md') || h.endsWith('.txt'))) showDoc(h);
})();

// ---- Build reference document list ----
const REF_DOCS = [
  { id: 'DB001', title: 'F18A Technology Reference', revisions: [
    { date: '2017', file: 'DB001-171107-F18A' },
    { date: '2022', file: 'DB001-221113-F18A' },
  ]},
  { id: 'DB003', title: 'EVB001 Evaluation Board', revisions: [
    { date: '2011a', file: 'DB003-110726-EVB001' },
    { date: '2011b', file: 'DB003-110926-EVB001' },
  ]},
  { id: 'DB004', title: 'arrayForth User\'s Manual', revisions: [{ date: '2013', file: 'DB004-131030-aFUSER' }]},
  { id: 'DB005', title: 'polyFORTH Reference', revisions: [{ date: '2012', file: 'DB005-120825-PF-REF' }]},
  { id: 'DB006', title: 'G144A12 polyFORTH Supplement', revisions: [{ date: '2022', file: 'DB006-221112-PF-G144A12' }]},
  { id: 'DB013', title: 'arrayForth 3 User\'s Manual', revisions: [{ date: '2022', file: 'DB013-221112-aFUSER' }]},
  { id: 'DB014', title: 'EVB002 Evaluation Board', revisions: [{ date: '2019', file: 'DB014-190520-EVB002' }]},
  { id: 'PB001', title: 'GA144 Product Brief', revisions: [{ date: '2010', file: 'PB001-100503-GA144-1-10' }]},
  { id: 'PB004', title: 'F18A I/O Facilities', revisions: [{ date: '2011', file: 'PB004-110412-F18A-IO' }]},
  { id: 'PB005', title: 'F18B Computer', revisions: [{ date: '2010', file: 'PB005-100501-F18B' }]},
  { id: 'PB006', title: 'F18B I/O Facilities', revisions: [{ date: '2010', file: 'PB006-100501-F18B-IO' }]},
  { id: 'PB008', title: 'GreenArrays Introduction', revisions: [{ date: '2010', file: 'PB008-100607-GA-Intro' }]},
  { id: 'AN001', title: 'MD5 Hash', revisions: [{ date: '2014', file: 'AN001-141023-MD5' }]},
  { id: 'AN002', title: 'Crystal Oscillator', revisions: [{ date: '2017', file: 'AN002-171106-OSC' }]},
  { id: 'AN003', title: 'SRAM Interface', revisions: [{ date: '2011', file: 'AN003-110810-SRAM' }]},
  { id: 'AN004', title: 'Getting Started EVB001', revisions: [{ date: '2011', file: 'AN004-111008-GS-EVB001' }]},
  { id: 'AN005', title: 'Schmart Board', revisions: [{ date: '2011', file: 'AN005-110926-SCHMART' }]},
  { id: 'AN007', title: '10BASE-T Ethernet', revisions: [
    { date: '2014a', file: 'AN007-141105-10BASET' },
    { date: '2014b', file: 'AN007-141112-10BASET' },
  ]},
  { id: 'AN008', title: 'Accelerometer', revisions: [{ date: '2012', file: 'AN008-120510-ACCEL' }]},
  { id: 'AN009', title: 'Keyboard Interface', revisions: [{ date: '2012', file: 'AN009-120912-KEYBRD' }]},
  { id: 'AN010', title: 'Snorkel Mark 1', revisions: [{ date: '2013', file: 'AN010-130604-SNORKEL1' }]},
  { id: 'AN011', title: 'Ganglia Mark 1', revisions: [{ date: '2013', file: 'AN011-130608-GANGLIA1' }]},
  { id: 'AN012', title: 'SensorTag I2C', revisions: [{ date: '2013', file: 'AN012-130606-SENSORTAG' }]},
  { id: 'AN016', title: 'DC Motor PID Controller', revisions: [
    { date: '2014a', file: 'AN016-141102-DCMOTOR' },
    { date: '2014b', file: 'AN016-141111-DCMOTOR' },
  ]},
  { id: 'AN017', title: 'Ganglia Mark 2', revisions: [{ date: '2017', file: 'AN017-170105-GANGLIA2' }]},
  { id: 'AN018', title: 'ADV7611 HDMI', revisions: [{ date: '2017', file: 'AN018-171105-ADV7611' }]},
  { id: 'AN020', title: '1080p Video', revisions: [{ date: '2017', file: 'AN020-171106-1080P' }]},
  { id: 'AN021', title: 'Getting Started EVB002', revisions: [
    { date: '2019', file: 'AN021-190520-GS-EVB002' },
    { date: '2022', file: 'AN021-220819-GS-EVB002' },
  ]},
  { id: 'AB002', title: 'Ethernet RX', revisions: [{ date: '2012', file: 'AB002-120108-ETH-RX' }]},
  { id: 'AB003', title: 'EVB Current Measurement', revisions: [{ date: '2012', file: 'AB003-121018-EVBCURR' }]},
  { id: 'AB004', title: 'Port Execution', revisions: [{ date: '2014', file: 'AB004-141021-PORTEX' }]},
  { id: 'AB005', title: 'Delay Lines/Buffers', revisions: [
    { date: '2017', file: 'AB005-171106-DELAY' },
    { date: '2022', file: 'AB005-220623-DELAY' },
  ]},
  { id: 'AB006', title: 'Transparent Port Bridge', revisions: [{ date: '2017', file: 'AB006-171108-BRIDGE' }]},
  { id: 'AB007', title: 'Update Flash', revisions: [
    { date: '2022a', file: 'AB007-220620-UPDFLASH' },
    { date: '2022b', file: 'AB007-221112-UPDFLASH' },
  ]},
  { id: 'BOOT', title: 'Boot Protocols', revisions: [{ date: '', file: 'BOOT-02' }]},
  { id: 'WP001', title: 'ADC Noise Reduction', revisions: [{ date: '2009', file: 'WP001-090805-noise' }]},
  { id: 'WP002', title: 'Energy Conservation', revisions: [{ date: '2010', file: 'WP002-100405-energycons' }]},
  { id: 'EVB001', title: 'EVB001 Schematics & Models', revisions: [
    { date: '2011a', file: 'EVB001_110717' },
    { date: '2011b', file: 'EVB001-v110717-model' },
    { date: '144x2', file: 'EVB001-144x2' },
  ]},
  { id: 'g144', title: 'GA144 Poster', revisions: [{ date: '', file: 'g144poster.A1' }]},
  { id: 'dpans94', title: 'ANS Forth Standard', revisions: [{ date: '1994', file: 'dpans94' }]},
  { id: 'PCBCOM', title: 'PCB Communications', revisions: [{ date: '2019', file: 'PCBCOM-190527' }]},
];

(function buildRefList() {
  const container = document.getElementById('ref-docs');
  if (!container) return;
  for (const doc of REF_DOCS) {
    const el = document.createElement('div');
    el.className = 'ref-item';
    const revLinks = doc.revisions.map(r => {
      const txtHref = 'txt/' + r.file + '.txt';
      const pdfHref = 'pdf/greenarrays/' + r.file + '.pdf';
      const label = r.date || 'view';
      return `<a href="#${txtHref}" onclick="event.preventDefault();history.pushState(null,'','#${txtHref}');showDoc('${txtHref}')" title="View text">${label}</a>` +
             `<a href="${pdfHref}" target="_blank" title="Original PDF">PDF</a>`;
    }).join(' ');
    el.innerHTML = `<span class="ref-id">${doc.id}</span>` +
                   `<span class="ref-title">${doc.title}</span>` +
                   `<span class="ref-links">${revLinks}</span>`;
    container.appendChild(el);
  }
})();
</script>
</body>
</html>
