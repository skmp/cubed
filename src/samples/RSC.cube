-- RSB: Runtime Shor's Algorithm — Serial Boot Output via Node 708
-- Like RSA but the Shor's computation runs near node 708 (the GA144
-- async boot node) so its results can be transmitted directly over the
-- async serial pin using the standard boot-wire protocol.
--
-- Node 708 uses asynctx{} — a bit-bang async serial TX builtin that
-- implements the emit1/emit8 protocol from rom-dump-bootstream.rkt:
--   emit1(bit): (bit & 1) XOR 3 → !b  then ~865-cycle baud delay
--   emit8(n):   start-bit(0), 8 data bits LSB-first, stop-bit(1)
--   emit18(n):  three emit8 calls for the full 18-bit word
-- (F18A 'or' opcode = XOR; drive-high = 0b11, drive-low = 0b10)
--
-- Note: ROM ibits18 (0xcb) is RX-only; there is no TX ROM function
-- on node 708. asynctx{} provides the equivalent TX path in RAM.
--
-- Architecture: 7 declared nodes
--   VGA:     117 (R delta), 617 (G delta), 717 (B delta), 217 (sync)
--   Noise:   508 (free-running counter → 608)
--   Compute: 608 (Shor's N=15, reads noise from 508, outputs to 708)
--   Serial:  708 (asynctx: reads 5 values from 608, transmits over pin)

-- ============================================================
-- RED DAC — DELTA VCO (node 117, analog)
-- ============================================================

node 117

/\

loop{n=480}
/\ deltarelay{port=0x141, count=640}
/\ send{port=0x145, value=0}
/\ again{}

-- ============================================================
-- GREEN DAC — DELTA VCO (node 617, analog)
-- ============================================================

node 617

/\

loop{n=480}
/\ deltarelay{port=0x141, count=640}
/\ again{}

-- ============================================================
-- BLUE DAC — DELTA VCO (node 717, analog)
-- ============================================================

node 717

/\

loop{n=480}
/\ deltarelay{port=0x141, count=640}
/\ again{}

-- ============================================================
-- SYNC SIGNALS (node 217 pin17 GPIO)
-- ============================================================

node 217

/\

loop{n=480}
/\ recv{port=0x145}
/\ send{port=0x15D, value=0x20000}
/\ again{}

/\

-- End of frame: VSYNC
send{port=0x15D, value=0x30000}

-- ============================================================
-- NOISE COUNTER (node 508 — free-running)
-- ============================================================
-- Increments a counter and sends it south to node 608.
-- The send blocks until 608 reads; thermal timing jitter means
-- the counter value at each read is nondeterministic.

node 508

/\

x = 0

/\

loop{n=32767}
/\ plus{a=x, b=1, c=x}
/\ send{port=0x115, value=x}
/\ again{}

-- ============================================================
-- SHOR'S COMPUTE (node 608 — basic node)
-- ============================================================
-- Reads noise from north (node 508 via DOWN=0x115), computes
-- Shor's factoring of N=15, sends results south to node 708.
-- 608 is even-y (y=6): south→UP=0x145, north→DOWN=0x115.

node 608

/\

shor15{noise_port=0x115, out_port=0x145}

-- ============================================================
-- ASYNC SERIAL TX (node 708 — async boot node)
-- ============================================================
-- Reads 5 values from north (node 608 via UP=0x145) and
-- transmits each as an 18-bit async serial word using the
-- boot-wire bit-bang protocol (emit1/emit8, ~865-cycle baud).
-- B is set to IO (0x15D) for pin drive via !b.
-- Values: N=15, a, r, p, q — sent in boot-wire frame format.

node 708

/\

loop{n=32767}
/\ asynctx{port=0x145, count=5}
/\ again{}
