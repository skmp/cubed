-- RSC: Runtime Shor's Algorithm — Continuous Serial Output via Node 708
-- Like RSA but the Shor's computation runs near node 708 (the GA144
-- async boot node) so its results can be transmitted continuously over
-- the async serial pin using the standard boot-wire protocol.
--
-- Node 708 uses std.asynctx{} — a bit-bang async serial TX builtin that
-- implements the emit1/emit8 protocol from rom-dump-bootstream.rkt:
--   emit1(bit): (bit & 1) XOR 3 → !b  (no baud std.delay in emulator)
--   emit8(n):   start-bit(0), 8 data bits LSB-first, stop-bit(1)
--   emit18(n):  three emit8 calls for the full 18-bit word
-- (F18A 'or' opcode = XOR; drive-high = 0b11, drive-low = 0b10)
--
-- Note: ROM ibits18 (0xcb) is RX-only; there is no TX ROM function
-- on node 708. std.asynctx{} provides the equivalent TX path in RAM.
--
-- Port directions (LUDR):
--   508 (odd-y=5):  north→UP=0x145 → 608
--   608 (even-y=6): south→UP=0x145 ← 508, north→DOWN=0x115 → 708
--   708 (odd-y=7):  south→DOWN=0x115 ← 608
--
-- Architecture: 7 declared nodes
--   VGA:     117 (R delta), 617 (G delta), 717 (B delta), 217 (sync)
--   Noise:   508 (free-running counter) →[UP/0x145]→ 608
--   Compute: 608 (Shor's N=15) →[DOWN/0x115]→ 708
--   Serial:  708 (std.asynctx continuous via DOWN/0x115)

-- ============================================================
-- RED DAC — DELTA VCO (node 117, analog)
-- ============================================================

#include std

/\

node 117

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.send{port=0x145, value=0}
/\ std.again{}

-- ============================================================
-- GREEN DAC — DELTA VCO (node 617, analog)
-- ============================================================

node 617

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.again{}

-- ============================================================
-- BLUE DAC — DELTA VCO (node 717, analog)
-- ============================================================

node 717

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.again{}

-- ============================================================
-- SYNC SIGNALS (node 217 pin17 GPIO)
-- ============================================================

node 217

/\

std.loop{n=480}
/\ std.recv{port=0x145}
/\ std.send{port=0x15D, value=0x20000}
/\ std.again{}

/\

-- End of frame: VSYNC
std.send{port=0x15D, value=0x30000}

-- ============================================================
-- NOISE COUNTER (node 508 — free-running)
-- ============================================================
-- Increments a counter and sends it north to node 608.
-- The std.send blocks until 608 reads; thermal timing jitter means
-- the counter value at each read is nondeterministic.
-- 508 is odd-y (y=5): north→UP=0x145.

node 508

/\

x = 0

/\

std.forever{}
/\ std.plus{a=x, b=1, c=x}
/\ std.send{port=0x145, value=x}
/\ std.repeat{}

-- ============================================================
-- SHOR'S COMPUTE (node 608 — basic node)
-- ============================================================
-- Reads noise from south (node 508 via UP=0x145), computes
-- Shor's factoring of N=15, sends results north to node 708.
-- 608 is even-y (y=6): south→UP=0x145, north→DOWN=0x115.

node 608

/\

std.shor15{noise_port=0x145, out_port=0x115}

-- ============================================================
-- ASYNC SERIAL TX (node 708 — async boot node)
-- ============================================================
-- Continuously reads values from south (node 608 via DOWN=0x115)
-- and transmits each as an 18-bit async serial word using the
-- boot-wire bit-bang protocol (emit1/emit8, ~865-cycle baud).
-- B is set to IO (0x15D) for pin drive via !b.
-- Values arrive in groups of 5 (N=15, a, r, p, q) from shor15.
-- 708 is odd-y (y=7): south→DOWN=0x115.

node 708

/\

std.asynctx{port=0x115}
