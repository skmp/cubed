-- RSB: Runtime Shor's Algorithm — Serial Boot Output via Node 708
-- Same as RSA but node 708 uses its native ROM function rom.ibits18
-- (0xcb) to receive 18-bit words from the async serial input pin,
-- writing each to IO. This is the ROM-idiomatic path for node 708.
--
-- Node 417 still sends Shor's results south to node 317 (std.relay chain
-- to IO for emulator capture). Node 708 independently reads from the
-- async serial pin using its ROM receive primitive — no hand-coded
-- @ std.loop needed.
--
-- Architecture: 8 declared nodes
--   VGA: 117 (R delta), 617 (G delta), 717 (B delta), 217 (sync)
--   Compute: 416 (noise counter) → 417 (Shor's algorithm)
--   Serial: 317 (IO output) + 708 (async serial RX via rom.ibits18)

-- ============================================================
-- RED DAC — DELTA VCO (node 117, analog)
-- ============================================================

#include std

/\

node 117

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.send{port=0x145, value=0}
/\ std.again{}

-- ============================================================
-- GREEN DAC — DELTA VCO (node 617, analog)
-- ============================================================

node 617

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.again{}

-- ============================================================
-- BLUE DAC — DELTA VCO (node 717, analog)
-- ============================================================

node 717

/\

std.loop{n=480}
/\ std.deltarelay{port=0x141, count=640}
/\ std.again{}

-- ============================================================
-- SYNC SIGNALS (node 217 pin17 GPIO)
-- ============================================================

node 217

/\

std.loop{n=480}
/\ std.recv{port=0x145}
/\ std.send{port=0x15D, value=0x20000}
/\ std.again{}

/\

-- End of frame: VSYNC
std.send{port=0x15D, value=0x30000}

-- ============================================================
-- NOISE COUNTER (node 416 — free-running)
-- ============================================================
-- Increments a counter and sends it east to node 417.
-- The std.send blocks until 417 reads; thermal timing jitter means
-- the counter value at each read is nondeterministic.

node 416

/\

x = 0

/\

std.loop{n=32767}
/\ std.plus{a=x, b=1, c=x}
/\ std.send{port=0x1D5, value=x}
/\ std.again{}

-- ============================================================
-- SHOR'S COMPUTE (node 417 — 1-pin GPIO)
-- ============================================================
-- Reads noise from west (node 416), computes Shor's factoring
-- of N=15, sends results south to node 317 for serial output.
-- out_port=0x145: node 417 is even-y (y=4), south→UP=0x145.

node 417

/\

std.shor15{noise_port=0x1D5, out_port=0x145}

-- ============================================================
-- SERIAL OUTPUT (node 317 — 1-pin GPIO)
-- ============================================================
-- Relays 5 values from north (node 417) to IO register.
-- Values: N=15, a, r, p, q — captured by emulator ring buffer.

node 317

/\

std.loop{n=32767}
/\ std.relay{port=0x145, count=5}
/\ std.again{}

-- ============================================================
-- ASYNC SERIAL RX (node 708 — boot node)
-- ============================================================
-- Uses rom.ibits18 (0xcb) — node 708's native ROM receive
-- primitive — to read 18-bit words from the async serial input
-- pin and write each to IO via f18a.storeb.
-- On real hardware: receives values sent by the host over serial
-- after boot and echoes them to IO.
-- 5 calls per std.loop matching the Shor's result frame format.

node 708

/\

std.loop{n=32767}
/\ rom.ibits18 /\ f18a.storeb
/\ rom.ibits18 /\ f18a.storeb
/\ rom.ibits18 /\ f18a.storeb
/\ rom.ibits18 /\ f18a.storeb
/\ rom.ibits18 /\ f18a.storeb
/\ std.again{}
