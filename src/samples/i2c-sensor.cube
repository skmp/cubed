-- I2C Sensor Bus (from sensortag.aforth / AN012)
-- Models the I2C protocol primitives used by the GA144
-- sensor tag application note. Three cooperating nodes:
--   Node 709: timing (pulls SCL high/low via DAC)
--   Node 708: bit-banged I2C master (clock + data)
--   Node 707: sensor register initialization sequences
--
-- I2C protocol:
--   START: SDA high->low while SCL high
--   STOP:  SDA low->high while SCL high
--   BIT:   Set SDA, pulse SCL, read ACK

#include std

/\

node 708

/\

-- I2C bus state
I2CState = Lambda{}. idle + start + data + stop

/\

-- Send a single bit: set data line, pulse clock
-- The clock node (709) handles SCL timing via DAC
i2c_send_bit = lambda{bit:Int, state:I2CState}.
  (std.shl{a=bit, n=1, c=data_pin} /\
   std.bor{a=data_pin, b=0x20000, c=io_val} /\
   std.send{port=0x1D5, value=io_val})

/\

-- Send START condition: SDA goes low while SCL is high
-- In F18A: set SDA=1, SCL=1, then SDA=0 while SCL stays high
i2c_start = lambda{}.
  (std.send{port=0x1D5, value=0x30000} /\
   std.send{port=0x1D5, value=0x20000})

/\

-- Send STOP condition: SDA goes high while SCL is high
i2c_stop = lambda{}.
  (std.send{port=0x1D5, value=0x20000} /\
   std.send{port=0x1D5, value=0x30000})

/\

-- Send one byte (8 bits) MSB first, receive ACK
-- Shift out each bit, then read ACK from slave
i2c_send_byte = lambda{byte:Int, ack:Int}.
  (std.shr{a=byte, n=7, c=b7} /\
   i2c_send_bit{bit=b7, state=data} /\
   std.shr{a=byte, n=6, c=b6t} /\
   std.band{a=b6t, b=1, c=b6} /\
   i2c_send_bit{bit=b6, state=data} /\
   std.shr{a=byte, n=5, c=b5t} /\
   std.band{a=b5t, b=1, c=b5} /\
   i2c_send_bit{bit=b5, state=data} /\
   std.shr{a=byte, n=4, c=b4t} /\
   std.band{a=b4t, b=1, c=b4} /\
   i2c_send_bit{bit=b4, state=data} /\
   std.recv{port=0x1D5, value=ack})

/\

-- Write to an I2C sensor register:
-- START, send device address + W, send register, send value, STOP
i2c_write_reg = lambda{dev:Int, reg:Int, val:Int}.
  (std.shl{a=dev, n=1, c=addr_w} /\
   i2c_start{} /\
   i2c_send_byte{byte=addr_w, ack=ack1} /\
   i2c_send_byte{byte=reg, ack=ack2} /\
   i2c_send_byte{byte=val, ack=ack3} /\
   i2c_stop{})

/\

-- Configure TMP006 temperature sensor (device 0x40):
-- Write 0x7100 to config register 0x02
-- (continuous conversion, 16 samples averaged)
i2c_write_reg{dev=0x40, reg=0x02, val=0x71}
