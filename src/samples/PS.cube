-- Palestine Flag (PS) VGA Output (EVB002 7-node architecture)
-- Renders the Palestine flag on a 640x480 framebuffer.
-- Three horizontal stripes (black, white, green) with a red triangle
-- on the left side (stepped approximation).
--
-- Architecture: feeder-std.relay pipeline (same as CH.cube).
--   Feeder nodes (116, 616, 716) generate pixel data via std.fill{}
--   with B redirected to the east port (RIGHT=0x1D5 for even-x nodes).
--   DAC std.relay nodes (117, 617, 717) read from west and write to IO.
--   R std.relay (117) signals sync node (217) after each row for HSYNC.
--
-- Flag layout (640x480):
--   Black stripe: rows 0-159 (160 rows)
--   White stripe: rows 160-319 (160 rows)
--   Green stripe: rows 320-479 (160 rows)
--   Red triangle: stepped approximation, widths per stripe:
--     Black stripe: 64px wide (x=0-63)
--     White stripe: 192px wide (x=0-191)
--     Green stripe: 64px wide (x=0-63)
--
-- Color breakdown per channel:
--   R: triangle=max, black stripe bg=0, white stripe bg=max, green stripe bg=0
--   G: triangle=0, black stripe bg=0, white stripe bg=max, green stripe bg=max
--   B: triangle=0, black stripe bg=0, white stripe bg=max, green stripe bg=0
--
-- DAC XOR encoding:
--   Zero output: 0x155, Max output: 0x0AA

-- ============================================================
-- RED DAC RELAY (node 117)
-- ============================================================

#include std

/\

node 117

/\

std.forever{}
/\ std.loop{n=480}
/\ std.relay{port=0x1D5, count=640}
/\ std.send{port=0x145, value=0}
/\ std.again{}
/\ std.repeat{}

-- ============================================================
-- GREEN DAC RELAY (node 617)
-- ============================================================

node 617

/\

std.forever{}
/\ std.loop{n=480}
/\ std.relay{port=0x1D5, count=640}
/\ std.again{}
/\ std.repeat{}

-- ============================================================
-- BLUE DAC RELAY (node 717)
-- ============================================================

node 717

/\

std.forever{}
/\ std.loop{n=480}
/\ std.relay{port=0x1D5, count=640}
/\ std.again{}
/\ std.repeat{}

-- ============================================================
-- RED FEEDER (node 116)
-- ============================================================
-- R = max for triangle + white stripe background.
-- Black stripe: 64px red triangle, rest zero.
-- White stripe: all max (triangle + white both have R=max).
-- Green stripe: 64px red triangle, rest zero.

node 116 { b=0x1D5 }

/\

std.forever{}

/\

-- Black stripe: 160 rows, 64px triangle (R=max) + 576px black (R=0)
std.loop{n=160}
/\ std.fill{value=0x0AA, count=64}
/\ std.fill{value=0x155, count=576}
/\ std.again{}

/\

-- White stripe: 160 rows, all R=max
std.loop{n=160}
/\ std.fill{value=0x0AA, count=640}
/\ std.again{}

/\

-- Green stripe: 160 rows, 64px triangle (R=max) + 576px green (R=0)
std.loop{n=160}
/\ std.fill{value=0x0AA, count=64}
/\ std.fill{value=0x155, count=576}
/\ std.again{}

/\ std.repeat{}

-- ============================================================
-- GREEN FEEDER (node 616)
-- ============================================================
-- G = 0 for triangle + black stripe. Max for white + green backgrounds.
-- Black stripe: all zero (black + red triangle both have G=0).
-- White stripe: 192px zero (triangle), 448px max (white).
-- Green stripe: 64px zero (triangle), 576px max (green).

node 616 { b=0x1D5 }

/\

std.forever{}

/\

-- Black stripe: 160 rows, all G=0
std.loop{n=160}
/\ std.fill{value=0x155, count=640}
/\ std.again{}

/\

-- White stripe: 160 rows, 192px triangle (G=0) + 448px white (G=max)
std.loop{n=160}
/\ std.fill{value=0x155, count=192}
/\ std.fill{value=0x0AA, count=448}
/\ std.again{}

/\

-- Green stripe: 160 rows, 64px triangle (G=0) + 576px green (G=max)
std.loop{n=160}
/\ std.fill{value=0x155, count=64}
/\ std.fill{value=0x0AA, count=576}
/\ std.again{}

/\ std.repeat{}

-- ============================================================
-- BLUE FEEDER (node 716)
-- ============================================================
-- B = 0 for triangle + black + green. Max for white background only.
-- Black stripe: all zero.
-- White stripe: 192px zero (triangle), 448px max (white).
-- Green stripe: all zero (green + red triangle both have B=0).

node 716 { b=0x1D5 }

/\

std.forever{}

/\

-- Black stripe: 160 rows, all B=0
std.loop{n=160}
/\ std.fill{value=0x155, count=640}
/\ std.again{}

/\

-- White stripe: 160 rows, 192px triangle (B=0) + 448px white (B=max)
std.loop{n=160}
/\ std.fill{value=0x155, count=192}
/\ std.fill{value=0x0AA, count=448}
/\ std.again{}

/\

-- Green stripe: 160 rows, all B=0
std.loop{n=160}
/\ std.fill{value=0x155, count=640}
/\ std.again{}

/\ std.repeat{}

-- ============================================================
-- SYNC SIGNALS (node 217 pin17 GPIO)
-- ============================================================

node 217

/\

std.forever{}
/\ std.loop{n=480}
/\ std.recv{port=0x145}
/\ std.send{port=0x15D, value=0x20000}
/\ std.again{}

/\

-- End of frame: VSYNC
std.send{port=0x15D, value=0x30000}

/\ std.repeat{}
