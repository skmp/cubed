-- Swiss Flag (CH) 640x480 VGA Output — Full Cross
-- Renders a Swiss flag centered on a 640x480 framebuffer.
-- Red 256x256 square with white cross (both horizontal and vertical bars).
--
-- Written in raw F18A assembly (f18a.*, lit.*, label{}).
--
-- Architecture: 12-node feeder-relay pipeline with per-row sync barrier.
--   R channel: feeder 116 → relay DAC 117
--   G channel: upstream feeder 615 → main feeder 616 → relay DAC 617
--   B channel: upstream feeder 715 → main feeder 716 → relay DAC 717
--   Sync: 217 receives "row done" from 117, emits HSYNC/VSYNC, then
--     broadcasts "start next row" south to 117 and north via relay chain
--     (317→417→517→617→717) to synchronize all 3 color channels.
--   The sync barrier compensates for thermal timing drift between nodes.
--
-- G/B channels are split across 2 feeder nodes each because the full
-- cross pattern (5 distinct row regions) exceeds 64-word RAM per node.
-- For all-uniform row regions, a single fill with count=rows*640 avoids
-- an outer loop, saving ~4 words per region.
--
-- EVB002 VGA wiring:
--   Node 117 DAC (117.ao) → R channel
--   Node 617 DAC (617.ao) → G channel
--   Node 717 DAC (717.ao) → B channel
--   Node 217 pin17 (GPIO) → HSYNC / VSYNC
--
-- DAC XOR encoding: write (desired ^ 0x155) to IO register.
--   Zero output:  0x000 ^ 0x155 = 0x155
--   Max output:   0x1FF ^ 0x155 = 0x0AA
--
-- Layout (640x480):
--   Flag: 256x256 at (192,112)-(447,367)
--   Horizontal bar: 160x64 at (240,208)-(399,271)
--   Vertical bar: 64x160 at (288,152)-(351,327)
--
-- Row breakdown for G/B channels (480 rows):
--   Rows 0-151:   black (152 rows)
--   Rows 152-207: vertical bar only (56 rows)
--   Rows 208-271: both bars (64 rows)
--   Rows 272-327: vertical bar only (56 rows)
--   Rows 328-479: black (152 rows)

-- ============================================================
-- RED FEEDER (node 116)
-- ============================================================
-- R = max (0x0AA) for entire 256x256 flag area (both red and white
-- cross areas have R=max). Black (0x155) outside flag.
-- B register set to east port (RIGHT=0x1D5 for even-x node).

node 116 { b=0x1D5 }

/\

-- Sync: send "go" signal east to 117
lit.hex18{value=0}
/\ f18a.storeb

/\

-- Rows 0-111: 112*640 = 71680 black pixels (NOPs for timing parity)
label{name=top}
/\ lit.hex18{value=71679}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f1}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f1}
/\ f18a.drop

/\

-- Rows 112-367: 256 rows, per-row pattern (192 black + 256 red + 192 black)
lit.hex18{value=255}
/\ f18a.push
/\ label{name=row}

/\

-- 192 black (NOPs for timing parity with G/B feeders)
lit.hex18{value=191}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f2}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f2}
/\ f18a.drop

/\

-- 256 red (NOPs for timing parity with G/B feeders)
lit.hex18{value=255}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f3}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f3}
/\ f18a.drop

/\

-- 192 black (NOPs for timing parity with G/B feeders)
lit.hex18{value=191}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f4}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f4}
/\ f18a.drop

/\

f18a.next{addr=row}

/\

-- Rows 368-479: 112*640 = 71680 black pixels (NOPs for timing parity)
lit.hex18{value=71679}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f5}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f5}
/\ f18a.drop

/\

f18a.jump{addr=top}

-- ============================================================
-- RED DAC RELAY (node 117)
-- ============================================================
-- Reads pixel data from west (RIGHT=0x1D5 for odd-x) and writes to DAC.
-- Per-row: wait for sync from 217, relay 640 pixels, signal 217 "done".

node 117

/\

-- Wait for sync "go" signal from 116
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ f18a.fetch
/\ f18a.drop

/\

label{name=frame}

/\

-- 480 rows
lit.hex18{value=479}
/\ f18a.push

/\

label{name=row}

/\

-- Wait for 217 "start row" via south (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ f18a.fetch
/\ f18a.drop

/\

-- Relay 640 pixels: read from west port, write to IO
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ lit.hex18{value=639}
/\ f18a.push
/\ label{name=px}
/\ f18a.fetch
/\ f18a.storeb
/\ f18a.next{addr=px}

/\

-- Signal sync node 217 "row done" via north (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ lit.hex18{value=0}
/\ f18a.store

/\

f18a.next{addr=row}

/\

f18a.jump{addr=frame}

-- ============================================================
-- SYNC MASTER (node 217 pin17 GPIO)
-- ============================================================
-- Per-row: send "start" north (chain) + south (117), wait for 117 "done",
-- emit HSYNC. After row 479: emit VSYNC instead, loop to next frame.

node 217 { b=0x15D }

/\

label{name=frame}

/\

-- 480 rows
lit.hex18{value=479}
/\ f18a.push

/\

label{name=row}

/\

-- Send "start row" north to relay chain (DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ lit.hex18{value=0}
/\ f18a.store

/\

-- Send "start row" south to 117 (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ lit.hex18{value=0}
/\ f18a.store

/\

-- Wait for 117 "row done" via south (UP=0x145, A already set)
f18a.fetch
/\ f18a.drop

/\

-- HSYNC: pin17 drive low = 0x20000 (write to B=0x15D)
lit.hex18{value=0x20000}
/\ f18a.storeb

/\

-- H-blank delay: ~160 pixel clocks worth of blanking.
-- Write pin17=weak pulldown (0x10000) to IO on each iteration so that
-- simulated time advances with IO writes (keeps timing in sync
-- with other nodes via the event queue, unlike bare NOPs).
-- Pin17 0x10000 = h-blank active (neither HSYNC nor VSYNC).
-- The last write marks h-blank end — the renderer uses it as the
-- active pixel period start.
lit.hex18{value=639}
/\ f18a.push
/\ lit.hex18{value=0x10000}
/\ label{name=hblank}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.next{addr=hblank}
/\ f18a.drop

/\

f18a.next{addr=row}

/\

-- VSYNC: pin17 drive high = 0x30000 (write to B=0x15D)
lit.hex18{value=0x30000}
/\ f18a.storeb

/\

-- V-blank delay: 45 lines × ~7680ns/line ≈ 345600ns.
-- Use IO writes (pin17=weak pulldown 0x10000) to keep timing synchronized.
-- Inner: dup storeb next = 3 ticks/iter × 2560 iters = 7680 ticks ≈ 1 line.
-- Outer: 45 iters.
lit.hex18{value=44}
/\ f18a.push
/\ label{name=vblank_outer}
/\ lit.hex18{value=2559}
/\ f18a.push
/\ lit.hex18{value=0x10000}
/\ label{name=vblank_inner}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.next{addr=vblank_inner}
/\ f18a.drop
/\ f18a.next{addr=vblank_outer}

/\

f18a.jump{addr=frame}

-- ============================================================
-- SYNC RELAY (node 317)
-- ============================================================
-- Forwards per-row sync signal from 217 (south) to 417 (north).
-- 317 is y=3 (odd): south=DOWN(0x115), north=UP(0x145).

node 317

/\

label{name=loop}

/\

-- Recv from south (DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ f18a.fetch

/\

-- Forward to north (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ f18a.store

/\

f18a.jump{addr=loop}

-- ============================================================
-- SYNC RELAY (node 417)
-- ============================================================
-- Forwards per-row sync signal from 317 (south) to 517 (north).
-- 417 is y=4 (even): south=UP(0x145), north=DOWN(0x115).

node 417

/\

label{name=loop}

/\

-- Recv from south (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ f18a.fetch

/\

-- Forward to north (DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ f18a.store

/\

f18a.jump{addr=loop}

-- ============================================================
-- SYNC RELAY (node 517)
-- ============================================================
-- Forwards per-row sync signal from 417 (south) to 617 (north).
-- 517 is y=5 (odd): south=DOWN(0x115), north=UP(0x145).

node 517

/\

label{name=loop}

/\

-- Recv from south (DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ f18a.fetch

/\

-- Forward to north (UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ f18a.store

/\

f18a.jump{addr=loop}

-- ============================================================
-- GREEN UPSTREAM FEEDER (node 615)
-- ============================================================
-- Generates rows 0-271 for G channel (top portion of frame).
-- Sends east to node 616 via LEFT=0x175 (odd-x node).

node 615 { b=0x175 }

/\

label{name=top}

/\

-- Rows 0-151: 152*640 = 97280 black pixels (single fill, no outer loop)
lit.hex18{value=97279}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f1}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- Rows 152-207: 56 rows, vertical bar pattern (288 black + 64 white + 288 black)
lit.hex18{value=55}
/\ f18a.push
/\ label{name=vbar1}

/\

-- 288 black
lit.hex18{value=287}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f2}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- 64 white
lit.hex18{value=63}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f3}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- 288 black
lit.hex18{value=287}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f4}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

f18a.next{addr=vbar1}

/\

-- Rows 208-271: 64 rows, both bars (240 black + 160 white + 240 black)
lit.hex18{value=63}
/\ f18a.push
/\ label{name=both}

/\

-- 240 black
lit.hex18{value=239}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f5}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- 160 white
lit.hex18{value=159}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f6}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- 240 black
lit.hex18{value=239}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f7}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

f18a.next{addr=both}

/\

f18a.jump{addr=top}

-- ============================================================
-- GREEN MAIN FEEDER (node 616)
-- ============================================================
-- Relays rows 0-271 from node 615 (via west LEFT=0x175), then generates
-- rows 272-479 locally. Sends east to 617 via RIGHT=0x1D5 (even-x).

node 616 { b=0x1D5 }

/\

-- Sync: send a "go" signal east to 617 so it doesn't start relaying
-- before we're ready (617 may boot and start running before us).
lit.hex18{value=0}
/\ f18a.storeb

/\

label{name=top}

/\

-- Relay rows 0-271 from 615: 272*640 = 174080 values
lit.hex18{value=0x175}
/\ f18a.astore
/\ lit.hex18{value=174079}
/\ f18a.push
/\ label{name=relay}
/\ f18a.fetch
/\ f18a.storeb
/\ f18a.next{addr=relay}

/\

-- Rows 272-327: 56 rows, vertical bar (277 black + 64 white + 299 black)
-- NOPs slow local generation to match relay pipeline timing.
-- Pixel counts shifted 11px left to compensate for NOP-induced constant offset.
lit.hex18{value=55}
/\ f18a.push
/\ label{name=vbar}

/\

-- 277 black
lit.hex18{value=276}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f1}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f1}
/\ f18a.drop

/\

-- 64 white
lit.hex18{value=63}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f2}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f2}
/\ f18a.drop

/\

-- 299 black
lit.hex18{value=298}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f3}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f3}
/\ f18a.drop

/\

f18a.next{addr=vbar}

/\

-- Rows 328-479: 152*640 = 97280 black pixels
lit.hex18{value=97279}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f4}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f4}
/\ f18a.drop

/\

f18a.jump{addr=top}

-- ============================================================
-- GREEN DAC RELAY (node 617)
-- ============================================================
-- Per-row: wait for sync from 517, forward to 717, relay 640 pixels.

node 617

/\

-- Wait for sync "go" signal from 616 (may boot before 616 is loaded)
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ f18a.fetch
/\ f18a.drop

/\

label{name=frame}

/\

lit.hex18{value=479}
/\ f18a.push

/\

label{name=row}

/\

-- Wait for sync from 517 (south = UP=0x145)
lit.hex18{value=0x145}
/\ f18a.astore
/\ f18a.fetch

/\

-- Forward sync to 717 (north = DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ f18a.store

/\

-- Relay 640 pixels: read from west (RIGHT=0x1D5)
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ lit.hex18{value=639}
/\ f18a.push
/\ label{name=px}
/\ f18a.fetch
/\ f18a.storeb
/\ f18a.next{addr=px}

/\

f18a.next{addr=row}

/\

f18a.jump{addr=frame}

-- ============================================================
-- BLUE UPSTREAM FEEDER (node 715)
-- ============================================================
-- Identical pattern to G upstream feeder (615) but on row 7.
-- Sends east to node 716 via LEFT=0x175 (odd-x node).

node 715 { b=0x175 }

/\

label{name=top}

/\

-- Rows 0-151: 152*640 = 97280 black pixels
lit.hex18{value=97279}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f1}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

-- Rows 152-207: 56 rows, vertical bar (288 black + 64 white + 288 black)
lit.hex18{value=55}
/\ f18a.push
/\ label{name=vbar1}

/\

lit.hex18{value=287}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f2}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

lit.hex18{value=63}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f3}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

lit.hex18{value=287}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f4}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

f18a.next{addr=vbar1}

/\

-- Rows 208-271: 64 rows, both bars (240 black + 160 white + 240 black)
lit.hex18{value=63}
/\ f18a.push
/\ label{name=both}

/\

lit.hex18{value=239}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f5}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

lit.hex18{value=159}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f6}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

lit.hex18{value=239}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f7}
/\ f18a.dup
/\ f18a.storeb
/\ f18a.unext
/\ f18a.drop

/\

f18a.next{addr=both}

/\

f18a.jump{addr=top}

-- ============================================================
-- BLUE MAIN FEEDER (node 716)
-- ============================================================
-- Relays rows 0-271 from 715 (via west LEFT=0x175), then generates
-- rows 272-479 locally. Sends east to 717 via RIGHT=0x1D5 (even-x).

node 716 { b=0x1D5 }

/\

-- Sync: send "go" signal east to 717
lit.hex18{value=0}
/\ f18a.storeb

/\

label{name=top}

/\

-- Relay rows 0-271 from 715: 272*640 = 174080 values
lit.hex18{value=0x175}
/\ f18a.astore
/\ lit.hex18{value=174079}
/\ f18a.push
/\ label{name=relay}
/\ f18a.fetch
/\ f18a.storeb
/\ f18a.next{addr=relay}

/\

-- Rows 272-327: 56 rows, vertical bar (277 black + 64 white + 299 black)
-- NOPs slow local generation to match relay pipeline timing.
-- Pixel counts shifted 11px left to compensate for NOP-induced constant offset.
lit.hex18{value=55}
/\ f18a.push
/\ label{name=vbar}

/\

-- 277 black
lit.hex18{value=276}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f1}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f1}
/\ f18a.drop

/\

-- 64 white
lit.hex18{value=63}
/\ f18a.push
/\ lit.hex18{value=0x0AA}
/\ label{name=f2}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f2}
/\ f18a.drop

/\

-- 299 black
lit.hex18{value=298}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f3}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f3}
/\ f18a.drop

/\

f18a.next{addr=vbar}

/\

-- Rows 328-479: 152*640 = 97280 black pixels
lit.hex18{value=97279}
/\ f18a.push
/\ lit.hex18{value=0x155}
/\ label{name=f4}
/\ f18a.dup
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.nop
/\ f18a.storeb
/\ f18a.next{addr=f4}
/\ f18a.drop

/\

f18a.jump{addr=top}

-- ============================================================
-- BLUE DAC RELAY (node 717)
-- ============================================================
-- Per-row: wait for sync from 617, relay 640 pixels.

node 717

/\

-- Wait for sync "go" signal from 716
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ f18a.fetch
/\ f18a.drop

/\

label{name=frame}

/\

lit.hex18{value=479}
/\ f18a.push

/\

label{name=row}

/\

-- Wait for sync from 617 (south = DOWN=0x115)
lit.hex18{value=0x115}
/\ f18a.astore
/\ f18a.fetch
/\ f18a.drop

/\

-- Relay 640 pixels: read from west (RIGHT=0x1D5)
lit.hex18{value=0x1D5}
/\ f18a.astore
/\ lit.hex18{value=639}
/\ f18a.push
/\ label{name=px}
/\ f18a.fetch
/\ f18a.storeb
/\ f18a.next{addr=px}

/\

f18a.next{addr=row}

/\

f18a.jump{addr=frame}
