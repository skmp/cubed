-- Swiss Flag (CH) 256x256 VGA Output (EVB002 7-node architecture)
-- Renders a Swiss flag centered on a 640x480 framebuffer.
-- Red square with white horizontal bar (simplified cross pattern).
--
-- Architecture: feeder-relay pipeline for synchronized RGB output.
--   Feeder nodes (116, 616, 716) generate pixel data using fill{}
--   with B redirected to the right port. The blocking port writes
--   synchronize all three channels per-pixel via the relay handshake.
--   DAC relay nodes (117, 617, 717) read from left and write to IO.
--
-- EVB002 VGA wiring:
--   Node 117 DAC (117.ao) -> R channel (J70 pin 1)
--   Node 617 DAC (617.ao) -> G channel (J70 pin 2)
--   Node 717 DAC (717.ao) -> B channel (J70 pin 3)
--   Node 217 pin17 (GPIO) -> HSYNC (J70 pin 4) / VSYNC (J70 pin 5)
--
-- DAC XOR encoding: write (desired ^ 0x155) to IO register.
--   Zero output:  0x000 ^ 0x155 = 0x155
--   Max output:   0x1FF ^ 0x155 = 0x0AA
--
-- Layout (absolute coordinates, 640x480):
--   Flag: 256x256 at (192,112)-(447,367)
--   Cross bar: 160x64 at (240,208)-(399,271)
--
-- Row breakdown (480 rows):
--   Rows 0-111:   black (112 rows)
--   Rows 112-207: red flag, no bar (96 rows)
--   Rows 208-271: red flag + white bar center (64 rows)
--   Rows 272-367: red flag, no bar (96 rows)
--   Rows 368-479: black (112 rows)

-- ============================================================
-- RED DAC RELAY (node 117)
-- ============================================================
-- Reads pixel data from west neighbor (node 116) via RIGHT port and writes to DAC.
-- (x=17 is odd, so west maps to RIGHT=0x1D5 in LUDR convention.)
-- Uses nested loop: 480 rows x 640 pixels (307200 total exceeds 18-bit).

node 117

/\

loop{n=480}
/\ relay{port=0x1D5, count=640}
/\ again{}

-- ============================================================
-- GREEN DAC RELAY (node 617)
-- ============================================================

node 617

/\

loop{n=480}
/\ relay{port=0x1D5, count=640}
/\ again{}

-- ============================================================
-- BLUE DAC RELAY (node 717)
-- ============================================================

node 717

/\

loop{n=480}
/\ relay{port=0x1D5, count=640}
/\ again{}

-- ============================================================
-- RED FEEDER (node 116)
-- ============================================================
-- R = max (0x0AA) for entire 256x256 flag area, zero (0x155) elsewhere.
-- Sends via fill{} with B redirected to right port.

node 116

/\

setb{addr=0x1D5}

/\

-- Black above flag: 112 rows
loop{n=112}
/\ fill{value=0x155, count=640}
/\ again{}

/\

-- Flag area: 256 rows (R is max across entire flag width)
loop{n=256}
/\ fill{value=0x155, count=192}
/\ fill{value=0x0AA, count=256}
/\ fill{value=0x155, count=192}
/\ again{}

/\

-- Black below flag: 112 rows
loop{n=112}
/\ fill{value=0x155, count=640}
/\ again{}

-- ============================================================
-- GREEN FEEDER (node 616)
-- ============================================================
-- G = max (0x0AA) for white bar only, zero (0x155) elsewhere.

node 616

/\

setb{addr=0x1D5}

/\

-- Black + red top: 208 rows (112 black + 96 red, both G=0)
loop{n=208}
/\ fill{value=0x155, count=640}
/\ again{}

/\

-- White bar rows: 64 rows
loop{n=64}
/\ fill{value=0x155, count=240}
/\ fill{value=0x0AA, count=160}
/\ fill{value=0x155, count=240}
/\ again{}

/\

-- Red bottom + black: 208 rows (96 red + 112 black, both G=0)
loop{n=208}
/\ fill{value=0x155, count=640}
/\ again{}

-- ============================================================
-- BLUE FEEDER (node 716)
-- ============================================================
-- B = same as G (white bar only).

node 716

/\

setb{addr=0x1D5}

/\

-- Black + red top: 208 rows
loop{n=208}
/\ fill{value=0x155, count=640}
/\ again{}

/\

-- White bar rows: 64 rows
loop{n=64}
/\ fill{value=0x155, count=240}
/\ fill{value=0x0AA, count=160}
/\ fill{value=0x155, count=240}
/\ again{}

/\

-- Red bottom + black: 208 rows
loop{n=208}
/\ fill{value=0x155, count=640}
/\ again{}

-- ============================================================
-- SYNC SIGNALS (node 217 pin17 GPIO)
-- ============================================================
-- HSYNC after each row, VSYNC at end of frame.

node 217

/\

-- 480 rows: delay to match relay timing, then send HSYNC
loop{n=480}
/\ delay{n=644}
/\ send{port=0x15D, value=0x20000}
/\ again{}

/\

-- End of frame: VSYNC
send{port=0x15D, value=0x30000}
